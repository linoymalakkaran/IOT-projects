{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "environmentName": {
            "type": "string",
            "metadata": {
                "description": "Environment name prefix"
            }
        },
        "location": {
            "type": "string",
            "metadata": {
                "description": "Primary deployment location"
            }
        },
        "logAnalyticsName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Log Analytics workspace"
            }
        },
        "appInsightsName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Application Insights"
            }
        },
        "iotHubName": {
            "type": "string",
            "metadata": {
                "description": "Name of the IoT Hub"
            }
        },
        "functionAppName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Function App"
            }
        },
        "streamAnalyticsName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Stream Analytics job"
            }
        },
        "cosmosDbAccountName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Cosmos DB account"
            }
        }
    },
    "variables": {
        "dashboardName": "[concat(parameters('environmentName'), '-dashboard')]",
        "actionGroupName": "[concat(parameters('environmentName'), '-actiongroup')]",
        "alertRules": {
            "iotHubErrors": "[concat(parameters('environmentName'), '-iothub-errors')]",
            "iotDeviceDisconnections": "[concat(parameters('environmentName'), '-device-disconnections')]",
            "functionErrors": "[concat(parameters('environmentName'), '-function-errors')]",
            "cosmosDbThrottling": "[concat(parameters('environmentName'), '-cosmosdb-throttling')]",
            "streamAnalyticsErrors": "[concat(parameters('environmentName'), '-asa-errors')]",
            "valveFailures": "[concat(parameters('environmentName'), '-valve-failures')]"
        },
        "dashboardGuid": "[guid(parameters('environmentName'), 'dashboard')]",
        "diagnosticSettingsName": "[concat(parameters('environmentName'), '-diagnostics')]"
    },
    "resources": [
        {
            "type": "Microsoft.Insights/actionGroups",
            "apiVersion": "2022-04-01",
            "name": "[variables('actionGroupName')]",
            "location": "Global",
            "properties": {
                "groupShortName": "WATALERTS",
                "enabled": true,
                "emailReceivers": [
                    {
                        "name": "Operations Team",
                        "emailAddress": "ops@wattreatment.com",
                        "useCommonAlertSchema": true
                    }
                ],
                "smsReceivers": [
                    {
                        "name": "On-Call Engineer",
                        "countryCode": "1",
                        "phoneNumber": "5555555555"
                    }
                ],
                "webhookReceivers": [
                    {
                        "name": "SCADA Integration",
                        "serviceUri": "https://scada-integration/alert-webhook",
                        "useCommonAlertSchema": true
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/metricAlerts",
            "apiVersion": "2018-03-01",
            "name": "[variables('alertRules').iotHubErrors]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
            ],
            "properties": {
                "description": "Alert when IoT Hub errors exceed threshold",
                "severity": 2,
                "enabled": true,
                "scopes": [
                    "[resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName'))]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                    "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                    "allOf": [
                        {
                            "name": "IoTHubErrors",
                            "metricName": "d2c.telemetry.egress.failures",
                            "operator": "GreaterThan",
                            "threshold": 10,
                            "timeAggregation": "Total",
                            "criterionType": "StaticThresholdCriterion"
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/metricAlerts",
            "apiVersion": "2018-03-01",
            "name": "[variables('alertRules').iotDeviceDisconnections]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
            ],
            "properties": {
                "description": "Alert when multiple IoT devices disconnect",
                "severity": 2,
                "enabled": true,
                "scopes": [
                    "[resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName'))]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                    "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                    "allOf": [
                        {
                            "name": "DeviceDisconnections",
                            "metricName": "devices.disconnected",
                            "operator": "GreaterThan",
                            "threshold": 50,
                            "timeAggregation": "Total",
                            "criterionType": "StaticThresholdCriterion"
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/metricAlerts",
            "apiVersion": "2018-03-01",
            "name": "[variables('alertRules').functionErrors]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
            ],
            "properties": {
                "description": "Alert when Azure Functions errors exceed threshold",
                "severity": 2,
                "enabled": true,
                "scopes": [
                    "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                    "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                    "allOf": [
                        {
                            "name": "FunctionErrors",
                            "metricName": "FunctionExecutionCount",
                            "dimensions": [
                                {
                                    "name": "Status",
                                    "operator": "Include",
                                    "values": [
                                        "Failure"
                                    ]
                                }
                            ],
                            "operator": "GreaterThan",
                            "threshold": 5,
                            "timeAggregation": "Total",
                            "criterionType": "StaticThresholdCriterion"
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/metricAlerts",
            "apiVersion": "2018-03-01",
            "name": "[variables('alertRules').cosmosDbThrottling]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
            ],
            "properties": {
                "description": "Alert when Cosmos DB throttling exceeds threshold",
                "severity": 2,
                "enabled": true,
                "scopes": [
                    "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                    "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                    "allOf": [
                        {
                            "name": "ThrottledRequests",
                            "metricName": "TotalRequestUnits",
                            "operator": "GreaterThan",
                            "threshold": 8000,
                            "timeAggregation": "Average",
                            "criterionType": "StaticThresholdCriterion"
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/metricAlerts",
            "apiVersion": "2018-03-01",
            "name": "[variables('alertRules').streamAnalyticsErrors]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
            ],
            "properties": {
                "description": "Alert when Stream Analytics job has errors",
                "severity": 2,
                "enabled": true,
                "scopes": [
                    "[resourceId('Microsoft.StreamAnalytics/streamingjobs', parameters('streamAnalyticsName'))]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                    "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                    "allOf": [
                        {
                            "name": "ConversionErrors",
                            "metricName": "ConversionErrors",
                            "operator": "GreaterThan",
                            "threshold": 10,
                            "timeAggregation": "Total",
                            "criterionType": "StaticThresholdCriterion"
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/scheduledQueryRules",
            "apiVersion": "2021-08-01",
            "name": "[variables('alertRules').valveFailures]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
            ],
            "properties": {
                "displayName": "Valve Operation Failures",
                "description": "Alert when valve operations fail",
                "severity": 1,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "scopes": [
                    "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
                ],
                "targetResourceTypes": [
                    "Microsoft.OperationalInsights/workspaces"
                ],
                "windowSize": "PT15M",
                "criteria": {
                    "allOf": [
                        {
                            "query": "customEvents\n| where name == \"ValveOperationEvent\" and customDimensions.success == \"false\"\n| summarize count() by bin(timestamp, 5m)",
                            "timeAggregation": "Count",
                            "operator": "GreaterThan",
                            "threshold": 5,
                            "failingPeriods": {
                                "numberOfEvaluationPeriods": 1,
                                "minFailingPeriodsToAlert": 1
                            }
                        }
                    ]
                },
                "autoMitigate": false,
                "actions": {
                    "actionGroups": [
                        "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                    ],
                    "customProperties": {}
                }
            }
        },
        {
            "type": "Microsoft.Portal/dashboards",
            "apiVersion": "2020-09-01-preview",
            "name": "[variables('dashboardGuid')]",
            "location": "[parameters('location')]",
            "tags": {
                "hidden-title": "[concat(parameters('environmentName'), ' Operations Dashboard')]"
            },
            "properties": {
                "lenses": {
                    "0": {
                        "order": 0,
                        "parts": {
                            "0": {
                                "position": {
                                    "x": 0,
                                    "y": 0,
                                    "colSpan": 6,
                                    "rowSpan": 4
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "resourceTypeMode",
                                            "isOptional": true,
                                            "value": "workspace"
                                        },
                                        {
                                            "name": "ComponentId",
                                            "isOptional": true,
                                            "value": {
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('logAnalyticsName')]",
                                                "ResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "isOptional": true,
                                            "value": "customEvents\n| where name == \"ValveOperationEvent\"\n| summarize count() by bin(timestamp, 1h), tostring(customDimensions.success)\n| render timechart"
                                        },
                                        {
                                            "name": "TimeRange",
                                            "isOptional": true,
                                            "value": "PT12H"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "isOptional": true,
                                            "value": {
                                                "xAxis": {
                                                    "name": "timestamp",
                                                    "type": "datetime"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "count_",
                                                        "type": "long"
                                                    }
                                                ],
                                                "splitBy": [
                                                    {
                                                        "name": "customDimensions_success",
                                                        "type": "string"
                                                    }
                                                ],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "Version",
                                            "isOptional": true,
                                            "value": "1.0"
                                        },
                                        {
                                            "name": "DashboardId",
                                            "isOptional": true,
                                            "value": "[variables('dashboardGuid')]"
                                        },
                                        {
                                            "name": "PartId",
                                            "isOptional": true,
                                            "value": "valve-operations-chart"
                                        },
                                        {
                                            "name": "PartTitle",
                                            "isOptional": true,
                                            "value": "Valve Operations"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "isOptional": true,
                                            "value": "Success vs. Failure"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "isOptional": true,
                                            "value": "workspace"
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsLineChartPart"
                                }
                            },
                            "1": {
                                "position": {
                                    "x": 6,
                                    "y": 0,
                                    "colSpan": 6,
                                    "rowSpan": 4
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "options",
                                            "isOptional": true,
                                            "value": {
                                                "chart": {
                                                    "metrics": [
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName'))]"
                                                            },
                                                            "name": "d2c.telemetry.ingress.success",
                                                            "aggregationType": "Total",
                                                            "namespace": "microsoft.devices/iothubs",
                                                            "metricVisualization": {
                                                                "displayName": "Telemetry messages sent"
                                                            }
                                                        },
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName'))]"
                                                            },
                                                            "name": "d2c.telemetry.ingress.allProtocol",
                                                            "aggregationType": "Total",
                                                            "namespace": "microsoft.devices/iothubs",
                                                            "metricVisualization": {
                                                                "displayName": "Telemetry message send attempts"
                                                            }
                                                        }
                                                    ],
                                                    "title": "IoT Hub Message Ingestion",
                                                    "visualization": {
                                                        "chartType": "Line",
                                                        "legendVisualization": {
                                                            "isVisible": true,
                                                            "position": "Bottom",
                                                            "hideSubtitle": false
                                                        },
                                                        "axisVisualization": {
                                                            "x": {
                                                                "isVisible": true,
                                                                "axisType": "Time"
                                                            },
                                                            "y": {
                                                                "isVisible": true,
                                                                "axisType": "Numeric"
                                                            }
                                                        }
                                                    },
                                                    "timespan": {
                                                        "relative": {
                                                            "duration": 86400000
                                                        },
                                                        "showUTCTime": false,
                                                        "grain": 1
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            "name": "sharedTimeRange",
                                            "isOptional": true,
                                            "value": {
                                                "relative": {
                                                    "duration": 86400000
                                                },
                                                "showUTCTime": false,
                                                "grain": 1
                                            }
                                        }
                                    ],
                                    "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                    "settings": {
                                        "content": {
                                            "options": {
                                                "chart": {
                                                    "metrics": [
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName'))]"
                                                            },
                                                            "name": "d2c.telemetry.ingress.success",
                                                            "aggregationType": "Total",
                                                            "namespace": "microsoft.devices/iothubs",
                                                            "metricVisualization": {
                                                                "displayName": "Telemetry messages sent"
                                                            }
                                                        },
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName'))]"
                                                            },
                                                            "name": "d2c.telemetry.ingress.allProtocol",
                                                            "aggregationType": "Total",
                                                            "namespace": "microsoft.devices/iothubs",
                                                            "metricVisualization": {
                                                                "displayName": "Telemetry message send attempts"
                                                            }
                                                        }
                                                    ],
                                                    "title": "IoT Hub Message Ingestion",
                                                    "visualization": {
                                                        "chartType": "Line",
                                                        "legendVisualization": {
                                                            "isVisible": true,
                                                            "position": "Bottom",
                                                            "hideSubtitle": false
                                                        },
                                                        "axisVisualization": {
                                                            "x": {
                                                                "isVisible": true,
                                                                "axisType": "Time"
                                                            },
                                                            "y": {
                                                                "isVisible": true,
                                                                "axisType": "Numeric"
                                                            }
                                                        }
                                                    },
                                                    "timespan": {
                                                        "relative": {
                                                            "duration": 86400000
                                                        },
                                                        "showUTCTime": false,
                                                        "grain": 1
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "2": {
                                "position": {
                                    "x": 0,
                                    "y": 4,
                                    "colSpan": 6,
                                    "rowSpan": 4
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "options",
                                            "isOptional": true,
                                            "value": {
                                                "chart": {
                                                    "metrics": [
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
                                                            },
                                                            "name": "TotalRequestUnits",
                                                            "aggregationType": "Total",
                                                            "namespace": "microsoft.documentdb/databaseaccounts",
                                                            "metricVisualization": {
                                                                "displayName": "Total Request Units"
                                                            }
                                                        },
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
                                                            },
                                                            "name": "DocumentCount",
                                                            "aggregationType": "Total",
                                                            "namespace": "microsoft.documentdb/databaseaccounts",
                                                            "metricVisualization": {
                                                                "displayName": "Document Count"
                                                            }
                                                        }
                                                    ],
                                                    "title": "Cosmos DB Usage",
                                                    "visualization": {
                                                        "chartType": "Line",
                                                        "legendVisualization": {
                                                            "isVisible": true,
                                                            "position": "Bottom",
                                                            "hideSubtitle": false
                                                        },
                                                        "axisVisualization": {
                                                            "x": {
                                                                "isVisible": true,
                                                                "axisType": "Time"
                                                            },
                                                            "y": {
                                                                "isVisible": true,
                                                                "axisType": "Numeric"
                                                            }
                                                        }
                                                    },
                                                    "timespan": {
                                                        "relative": {
                                                            "duration": 86400000
                                                        },
                                                        "showUTCTime": false,
                                                        "grain": 1
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            "name": "sharedTimeRange",
                                            "isOptional": true,
                                            "value": {
                                                "relative": {
                                                    "duration": 86400000
                                                },
                                                "showUTCTime": false,
                                                "grain": 1
                                            }
                                        }
                                    ],
                                    "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                    "settings": {}
                                }
                            },
                            "3": {
                                "position": {
                                    "x": 6,
                                    "y": 4,
                                    "colSpan": 6,
                                    "rowSpan": 4
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "resourceTypeMode",
                                            "isOptional": true,
                                            "value": "workspace"
                                        },
                                        {
                                            "name": "ComponentId",
                                            "isOptional": true,
                                            "value": {
                                                "SubscriptionId": "[subscription().subscriptionId]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('logAnalyticsName')]",
                                                "ResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "isOptional": true,
                                            "value": "customEvents\n| where name == \"WaterQualityReport\"\n| project timestamp, deviceId = tostring(customDimensions.deviceId), quality = todouble(customDimensions.waterQuality)\n| summarize avgQuality = avg(quality) by bin(timestamp, 1h), deviceId\n| render timechart"
                                        },
                                        {
                                            "name": "TimeRange",
                                            "isOptional": true,
                                            "value": "PT12H"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "isOptional": true,
                                            "value": {
                                                "xAxis": {
                                                    "name": "timestamp",
                                                    "type": "datetime"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "avgQuality",
                                                        "type": "real"
                                                    }
                                                ],
                                                "splitBy": [
                                                    {
                                                        "name": "deviceId",
                                                        "type": "string"
                                                    }
                                                ],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "Version",
                                            "isOptional": true,
                                            "value": "1.0"
                                        },
                                        {
                                            "name": "PartId",
                                            "isOptional": true,
                                            "value": "water-quality-chart"
                                        },
                                        {
                                            "name": "PartTitle",
                                            "isOptional": true,
                                            "value": "Water Quality Trends"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "isOptional": true,
                                            "value": "By Device"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "isOptional": true,
                                            "value": "workspace"
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsLineChartPart"
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2021-05-01-preview",
            "name": "[concat(parameters('iotHubName'), '/', variables('diagnosticSettingsName'))]",
            "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                    {
                        "category": "Connections",
                        "enabled": true
                    },
                    {
                        "category": "DeviceTelemetry",
                        "enabled": true
                    },
                    {
                        "category": "C2DCommands",
                        "enabled": true
                    },
                    {
                        "category": "DeviceIdentityOperations",
                        "enabled": true
                    },
                    {
                        "category": "FileUploadOperations",
                        "enabled": true
                    },
                    {
                        "category": "Routes",
                        "enabled": true
                    },
                    {
                        "category": "D2CTwinOperations",
                        "enabled": true
                    },
                    {
                        "category": "C2DTwinOperations",
                        "enabled": true
                    },
                    {
                        "category": "TwinQueries",
                        "enabled": true
                    },
                    {
                        "category": "JobsOperations",
                        "enabled": true
                    },
                    {
                        "category": "DirectMethods",
                        "enabled": true
                    },
                    {
                        "category": "DistributedTracing",
                        "enabled": true
                    },
                    {
                        "category": "Configurations",
                        "enabled": true
                    },
                    {
                        "category": "DeviceStreams",
                        "enabled": true
                    }
                ],
                "metrics": [
                    {
                        "category": "AllMetrics",
                        "enabled": true
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            ]
        },
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2021-05-01-preview",
            "name": "[concat(parameters('cosmosDbAccountName'), '/', variables('diagnosticSettingsName'))]",
            "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                    {
                        "category": "DataPlaneRequests",
                        "enabled": true
                    },
                    {
                        "category": "MongoRequests",
                        "enabled": true
                    },
                    {
                        "category": "QueryRuntimeStatistics",
                        "enabled": true
                    },
                    {
                        "category": "PartitionKeyStatistics",
                        "enabled": true
                    },
                    {
                        "category": "PartitionKeyRUConsumption",
                        "enabled": true
                    },
                    {
                        "category": "ControlPlaneRequests",
                        "enabled": true
                    }
                ],
                "metrics": [
                    {
                        "category": "Requests",
                        "enabled": true
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            ]
        },
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2021-05-01-preview",
            "name": "[concat(parameters('functionAppName'), '/', variables('diagnosticSettingsName'))]",
            "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                    {
                        "category": "FunctionAppLogs",
                        "enabled": true
                    }
                ],
                "metrics": [
                    {
                        "category": "AllMetrics",
                        "enabled": true
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            ]
        },
        {
            "type": "Microsoft.Insights/workbooks",
            "apiVersion": "2021-08-01",
            "name": "[concat(guid(concat(parameters('environmentName'), '-workbook')), '')]",
            "location": "[parameters('location')]",
            "kind": "shared",
            "properties": {
                "displayName": "WAT Operations Workbook",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# WAT Water Treatment Operations\\r\\n\\r\\nThis workbook provides operational insights into the Water Treatment system.\"},\"name\":\"title\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a3e2a12c-0c05-4bd0-a8f6-a02c0ca55d71\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000}]}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\"},\"name\":\"parameters - time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\r\\n| where name == \\\"ValveOperationEvent\\\"\\r\\n| summarize count() by bin(timestamp, 1h), tostring(customDimensions.success)\\r\\n| render timechart\",\"size\":0,\"title\":\"Valve Operations\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"chartSettings\":{\"group\":null,\"createOtherGroup\":0,\"showDataPoints\":true,\"ySettings\":{\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"customWidth\":\"50\",\"name\":\"valve-operations\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\r\\n| where name == \\\"WaterQualityReport\\\"\\r\\n| project timestamp, deviceId = tostring(customDimensions.deviceId), quality = todouble(customDimensions.waterQuality)\\r\\n| summarize avgQuality = avg(quality) by bin(timestamp, 1h), deviceId\\r\\n| render timechart\",\"size\":0,\"title\":\"Water Quality Trends\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"water-quality\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\r\\n| where name == \\\"DeviceConnectionStatus\\\"\\r\\n| summarize count() by bin(timestamp, 1h), tostring(customDimensions.status)\\r\\n| render columnchart\",\"size\":0,\"title\":\"Device Connection Status\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"device-connection-status\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\r\\n| where name == \\\"WaterFlowReport\\\"\\r\\n| project timestamp, deviceId = tostring(customDimensions.deviceId), flowRate = todouble(customDimensions.flowRate)\\r\\n| summarize avgFlow = avg(flowRate) by bin(timestamp, 1h)\\r\\n| render timechart\",\"size\":0,\"title\":\"Average Water Flow Rate\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"avg-flow-rate\"}]}",
                "version": "1.0",
                "sourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "category": "workbook"
            },
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            ]
        }
    ],
    "outputs": {
        "dashboardUrl": {
            "type": "string",
            "value": "[concat('https://portal.azure.com/#blade/Microsoft_Azure_Dashboard/DashboardBlade/id/', resourceGroup().id, '/dashboards/', variables('dashboardGuid'))]"
        },
        "workbookId": {
            "type": "string",
            "value": "[resourceId('Microsoft.Insights/workbooks', concat(guid(concat(parameters('environmentName'), '-workbook')), ''))]"
        }
    }
}